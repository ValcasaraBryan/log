#!/usr/bin/env sh

echo "post-commit"

# Path to package.json
PACKAGE_PATH="package.json"

# Check if package.json exists
if [ -f "$PACKAGE_PATH" ]; then
    # Extract current version number
    CURRENT_VERSION=$(grep -oP '(?<="version": ")[0-9]+\.[0-9]+\.[0-9]+(?=")' "$PACKAGE_PATH")
    
    if [ ! -z "$CURRENT_VERSION" ]; then
        # Create version tag
        if ! git rev-parse -q --verify "refs/tags/v$CURRENT_VERSION" >/dev/null; then
            git tag "v$CURRENT_VERSION"
        else
            echo "Error: tag v$CURRENT_VERSION already exists"
        fi
        
        # Check if latest tag exists and delete it if it does
        if git rev-parse -q --verify refs/tags/latest >/dev/null; then
            git tag -d "latest"
            git push origin :refs/tags/latest 2>/dev/null || true
        else
            echo "Error: latest tag not found"
        fi
        
        # Create new latest tag
        git tag "latest"
        
        # Force push the tags
        git push --tags
        
        echo "Successfully created and pushed tags: v$CURRENT_VERSION and latest"
    else
        echo "Error: version not found in package.json"
        exit 1
    fi
else
    echo "Error: package.json not found"
    exit 1
fi
exit 0